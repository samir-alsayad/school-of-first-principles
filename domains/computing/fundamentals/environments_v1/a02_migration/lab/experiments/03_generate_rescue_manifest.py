
import json
import os

def generate_rescue_manifest():
    json_path = "../intelhub_dependency_gap.json"
    output_path = "../rescue_requirements.txt"
    
    print(f"[*] Reading Scan Data from {json_path}...")
    
    try:
        with open(json_path, 'r') as f:
            data = json.load(f)
            
        undeclared = data.get("undeclared", [])
        
        if not undeclared:
            print("[!] No undeclared packages found. IntelHub is clean (unlikely).")
            return

        print(f"[*] Found {len(undeclared)} undeclared dependencies.")
        
        # Sort for readability
        undeclared.sort()
        
        with open(output_path, 'w') as f:
            f.write("# IntelHub Rescue Manifest\n")
            f.write("# Generated by Module 02: Env Migration (Deep Scan)\n")
            f.write("# These packages were detected in source code but missing from requirements.txt\n\n")
            
            for pkg in undeclared:
                f.write(f"{pkg}\n")
                
        print(f"[+] Rescue Manifest written to {output_path}")
        print("[-] Next Step: Copy this to IntelHub root and run 'pip install -r requirements.txt' in a NEW venv.")

    except FileNotFoundError:
        print(f"[-] Error: Could not find {json_path}. Did you run the Deep Scan?")

if __name__ == "__main__":
    generate_rescue_manifest()
